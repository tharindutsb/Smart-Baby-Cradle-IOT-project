// Smart Cradle Arduino Code - With Auto Rocking Based on Motion & Sound, Smooth Start/Stop

#include <DHT.h>

// Pin Definitions
#define DHTPIN 2
#define DHTTYPE DHT22
#define SOUND_SENSOR A0
#define WET_SENSOR A1
#define PIR_SENSOR 3
#define MOTOR_IN1 4
#define MOTOR_IN2 5
#define MOTOR_ENA 6
#define FAN_PIN 7
#define BUZZER_PIN 8
#define SOUND_VCC 9
#define WET_VCC 10

DHT dht(DHTPIN, DHTTYPE);

// System Variables
int motorSpeed = 180;          // V1 - Cradle rocking speed
bool fanManual = false;        // V2 - Fan manual control
bool buzzerEnabled = false;    // V3 - Buzzer control
int tempThreshold = 28;        // V7 - Fan temp threshold
bool autoRockingEnabled = true;// V8 - Auto-rocking toggle
int soundThreshold = 45;       // V9 - Sound threshold (%)
bool rocking = false;

// Sensor reading variables
int soundPercent = 0;
int wetPercent = 0;
float temperature = 0;
float humidity = 0;

unsigned long rockingStart = 0;
bool motionDetected = false;
bool soundDetected = false;

unsigned long lastRockTime = 0;
int cradlePhase = 0;
unsigned long lastSwingTime = 0;
const int swingDuration = 1500; // time per direction

void setup() {
  Serial.begin(115200);
  while (!Serial);

  pinMode(SOUND_VCC, OUTPUT);
  pinMode(WET_VCC, OUTPUT);
  pinMode(PIR_SENSOR, INPUT);
  pinMode(MOTOR_IN1, OUTPUT);
  pinMode(MOTOR_IN2, OUTPUT);
  pinMode(MOTOR_ENA, OUTPUT);
  pinMode(FAN_PIN, OUTPUT);
  pinMode(BUZZER_PIN, OUTPUT);

  digitalWrite(SOUND_VCC, LOW);
  digitalWrite(WET_VCC, LOW);
  digitalWrite(FAN_PIN, LOW);
  digitalWrite(BUZZER_PIN, LOW);

  dht.begin();
  Serial.println("[ARDUINO] System Ready");
}

void loop() {
  handleSerialCommands();

  static unsigned long lastSend = 0;
  if (millis() - lastSend >= 2000) {
    readSensors();
    sendSensorData();
    lastSend = millis();
  }

  handleAutoRocking();
  handleAutoFan();
  handleWetnessAlert();
  handleCradleMotion();
}

void readSensors() {
  // Read sound sensor
  digitalWrite(SOUND_VCC, HIGH);
  delay(50);
  int soundRaw = analogRead(SOUND_SENSOR);
  digitalWrite(SOUND_VCC, LOW);
  soundPercent = map(soundRaw, 0, 1023, 0, 100);

  // Read wetness sensor
  digitalWrite(WET_VCC, HIGH);
  delay(50);
  int wetRaw = analogRead(WET_SENSOR);
  digitalWrite(WET_VCC, LOW);
  wetPercent = map(wetRaw, 1023, 0, 0, 100);

  temperature = dht.readTemperature();
  humidity = dht.readHumidity();
}

void handleSerialCommands() {
  static String buffer = "";
  while (Serial.available()) {
    char c = Serial.read();
    if (c == '\n') {
      processCommand(buffer);
      buffer = "";
    } else {
      buffer += c;
    }
  }
}

void processCommand(String cmd) {
  cmd.trim();
  if (cmd.startsWith("MOTOR:")) {
    motorSpeed = constrain(cmd.substring(6).toInt(), 0, 255);
  } else if (cmd.startsWith("FAN:")) {
    fanManual = cmd.substring(4).toInt() == 1;
    digitalWrite(FAN_PIN, fanManual);
  } else if (cmd.startsWith("BUZZER:")) {
    buzzerEnabled = cmd.substring(7).toInt() == 1;
  } else if (cmd.startsWith("TEMP_THRESH:")) {
    tempThreshold = cmd.substring(12).toInt();
  } else if (cmd.startsWith("AUTO_ROCK:")) {
    autoRockingEnabled = cmd.substring(10).toInt() == 1;
  } else if (cmd.startsWith("SOUND_THRESH:")) {
    soundThreshold = constrain(cmd.substring(13).toInt(), 0, 100);
  }
}

void sendSensorData() {
  int motion = digitalRead(PIR_SENSOR);
  String data = "$" + String(temperature,1) + "|" + String(humidity,1) + "|" + 
                String(wetPercent) + "|" + String(soundPercent) + "|" + 
                String(motion) + "|" + String(motorSpeed) + "|" + 
                String(fanManual) + "|" + String(buzzerEnabled) + "#";
  Serial.println(data);
}

void handleAutoRocking() {
  if (!autoRockingEnabled) return;

  motionDetected = digitalRead(PIR_SENSOR);
  soundDetected = soundPercent > soundThreshold;

  if (motionDetected || soundDetected) {
    rockingStart = millis();
    if (!rocking) {
      rockCradleAsync();
    }
  } else {
    if (rocking && millis() - rockingStart > 30000) {
      stopCradleSmoothly();
    }
  }
}

void rockCradleAsync() {
  rocking = true;
  cradlePhase = 0;
  lastSwingTime = millis() - swingDuration;
}

void handleCradleMotion() {
  if (!rocking) return;

  if (millis() - lastSwingTime >= swingDuration) {
    lastSwingTime = millis();
    if (cradlePhase % 2 == 0) {
      digitalWrite(MOTOR_IN1, HIGH);
      digitalWrite(MOTOR_IN2, LOW);
    } else {
      digitalWrite(MOTOR_IN1, LOW);
      digitalWrite(MOTOR_IN2, HIGH);
    }

    for (int pwm = 0; pwm <= motorSpeed; pwm += 15) {
      analogWrite(MOTOR_ENA, pwm);
      delay(30);
    }
    delay(1000);
    for (int pwm = motorSpeed; pwm >= 0; pwm -= 15) {
      analogWrite(MOTOR_ENA, pwm);
      delay(30);
    }
    analogWrite(MOTOR_ENA, 0);
    cradlePhase++;
  }
}

void stopCradleSmoothly() {
  rocking = false;
  analogWrite(MOTOR_ENA, 0);
  digitalWrite(MOTOR_IN1, LOW);
  digitalWrite(MOTOR_IN2, LOW);
}

void handleAutoFan() {
  if (fanManual) return;
  digitalWrite(FAN_PIN, temperature > tempThreshold ? HIGH : LOW);
}

void handleWetnessAlert() {
  static unsigned long lastAlert = 0;
  if (wetPercent > 50 && millis() - lastAlert > 30000) {
    if (buzzerEnabled) {
      digitalWrite(BUZZER_PIN, HIGH);
      delay(2000);
      digitalWrite(BUZZER_PIN, LOW);
    }
    lastAlert = millis();
  }
}